def registry_url = "192.168.0.81:18080"
def repository = "openmajun"
def registry_auth = "dc837f6d-704e-4e69-99ac-180fd3ec98f2"
def project_name = "openmajun-poisoning"
def image_name = "${project_name}:slave"

pipeline {
    agent {
        node{
           label "node01"
        }
    }
    stages {
        stage('编译构建') {
            steps {
                sh '''
                pwd
                apt update  && apt install wget maven git -y
                wget --no-cookies --no-check-certificate --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/8u141-b15/336fa29ff2bb4ef291e347e091f7f4a7/jdk-8u141-linux-x64.tar.gz"
                mkdir /usr/local/java
                tar zxvf jdk-8u141-linux-x64.tar.gz -C /usr/local/java
                ln -s /usr/local/java/jdk1.8.0_141 /usr/local/java/jdk
                export JAVA_HOME /usr/local/java/jdk
                export JRE_HOME ${JAVA_HOME}/jre
                export CLASSPATH .:${JAVA_HOME}/lib:${JRE_HOME}/lib
                export PATH ${JAVA_HOME}/bin:$PATH
                mvn --version
                mvn  -gs ./setting-new.xml clean install -Dmaven.test.skip=true
                touch entrypoint.sh
                echo "#!/bin/bash\n nohup java -jar /root/.m2/repository/anti-poisoning-0.0.1-SNAPSHOT.jar &" >>  /usr/local/entrypoint.sh
                chmod u+x /usr/local/entrypoint.sh
                '''
            }
        }

        stage('镜像制作上传') {
            steps {
                dir(""){
                    sh "pwd"
                    echo "image name: ${image_name}"
                    withCredentials(
                        [usernamePassword(credentialsId: "${registry_auth}", usernameVariable: 'username', passwordVariable: 'password')]
                    ){
                        sh "docker build -t ${image_name} ."
                        sh "docker login -u ${username} -p ${password} ${registry_url}"
                        sh "docker push ${image_name}"
                        sh "echo 镜像 ${image_name} 上传成功"
                    }
                }
            }
        }
    }
}