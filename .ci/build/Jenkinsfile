//def registry_url = "192.168.0.42:5000"
def registry_url = "192.168.0.81:18080"
//def repository = "cloudsca"
def repository = "openmajun"
//def registry_auth = "57386086-c8ac-4dd4-a2ae-900e3328e3e9"
def registry_auth = "dc837f6d-704e-4e69-99ac-180fd3ec98f2"
//def API_SERVER = "https://192.168.0.42:6443"
def deploy_name = "anti-poisoning"
def project_name = "openmajun-poisoning"
//def image_name = "${registry_url}/${repository}/${project_name}:${BUILD_TIMESTAMP}"
def image_name = "${project_name}:slave"
def namespace = "openmajun"
def deploy_replicas=1

pipeline {
     agent any
        //agent {
        //    node{
         //       label "jenkins-slave"
        //    }
        //}

    stages {
        stage('编译构建') {
            steps {
                sh "pwd"
                sh label: '', script: 'mvn  -gs ./setting-new.xml clean install -Dmaven.test.skip=true'
            }
        }

        stage('镜像制作上传') {
            steps {
                dir(""){
                    sh "pwd"
                    echo "image name: ${image_name}"
                    withCredentials(
                        [usernamePassword(credentialsId: "${registry_auth}", usernameVariable: 'username', passwordVariable: 'password')]
                    ){
                        sh "docker build -t ${image_name} ."
                        sh "docker login -u ${username} -p ${password} ${registry_url}"
                        sh "docker push ${image_name}"
                        sh "echo 镜像 ${image_name} 上传成功"
                    }
                }
            }
        }
    }
}