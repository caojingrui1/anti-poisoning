def git_address = "https://gitee.com/openMajun_enterprise/anti-poisoning.git"
def git_auth = "0ecab2a3-034c-4b18-9464-190dcbb7c149"
def registry_url = "192.168.0.81:18080"
def repository = "openmajun"
def registry_auth = "dc837f6d-704e-4e69-99ac-180fd3ec98f2"
def project_name = "openmajun-poisoning"
def image_name = "${project_name}:slave"

pipeline {
    agent any
    stages {
        stage('编译构建') {
            steps {
                sh "pwd"
                sh "whereis maven"
                sh "source /etc/profile"
                sh label: '', script: 'mvn  -gs ./setting-new.xml clean install -Dmaven.test.skip=true'
            }
        }

        stage('镜像制作上传') {
            steps {
                dir(""){
                    sh "pwd"
                    echo "image name: ${image_name}"
                    withCredentials(
                        [usernamePassword(credentialsId: "${registry_auth}", usernameVariable: 'username', passwordVariable: 'password')]
                    ){
                        sh "docker build -t ${image_name} ."
                        sh "docker login -u ${username} -p ${password} ${registry_url}"
                        sh "docker push ${image_name}"
                        sh "echo 镜像 ${image_name} 上传成功"
                    }
                }
            }
        }
    }
}